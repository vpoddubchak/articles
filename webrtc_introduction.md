### Знакомство с WebRTC

#### Появление WebRTC

Привлекательность информации в интернете сделала своё дело: на сегодняшний день веб-браузер занял основное место на рабочем столе ноутбука.  С годами он из простого интерпретатора превратился в мощный инструмент который позволяет решить практически любые задачи. А с распространением мобильных девайсов, его присутсвие в нашей повседнейвной жизни только увеличилось. Сегодня мы можем совершать видео-звонки прямо из окна браузера. Давайте вернемся на 10 лет назад и посмотрим как это зарождалось.

##### Поглощение On2
В 2009 году существовала компания On2 Technologies. На тот момент она была на рынке уже 19 лет и занималась разработкой видео кодеков для игр. На заре своего существования, в начале 90-х они отличались от тогдашнего MPEG тем что могли декодировать видео в реальном времени не прибегая к использованию дополнительных процессоров. Их кодеки использовались в игровых консолях.

Постепенно они перешли и на десктопы: Mac и Windows. Первые версии кодеков для них были выпущены в 1996 году. Тогда они уже позволяли захватывать видео и кодировать в реальном времени. 

В 2001 году компания выпустила новую версию кодека "VP3" и сделала его open-source. Постепенно улучшая алгоритмы и оптимизируя его под современные процессоры, к 2008 году у них уже был кодек VP8. На котором для них все и закончилось (хорошо).

Закончилось хорошо, потому что 7-го января 2010 года, совет директоров компании согласился принять пердложение о поглощении компанией Google. Сумма сделки - $124 млн. Целью данного поглощения было найти альтернативу видео-кодеку h.264 и при этом не платить роялти.

##### Поглощение GIPS (Global IP Solution)

Google на этом не остановилась. Ведь для полной картины им не хватало собственного аудио-кодека. Их выбор остановился на компании Global IP Solution. Эта компания была извесна тем что до 2007 года её аудио-кодек iSAC (internet Speech Audio Codec) использовался в Skype. Также Компания GIPS имела наработки в сфере VoIP которые подходили под задачи Google. Сумма сделки $68 млн.

Все скупленное Google сделала opensource.

Теперь у компании были в наличии все технологии необходимые для совершения видео-звонков:
1. Видео кодек VP8
2. Аудио кодек iSAC
3. Протокол передачи контрольных сообщений был бесплатный (SIP)
4. Протокол передачи медиа данных тоже бесплатный(RTP)

Теперь за дело взялись инженеры Google. Идея была создать API который мог бы легко использоваться в приложениях для совершения видео-звонков. Естетсвенно, нужен был яркий пример как использовать это API. Им стал Hangouts, который был выпущен в июле 2014-го года.


#### Уникальность WebRTC

Появившись на свет, WebRTC должен был быть лучше существующих решений для видео-звонков, давайте рассмотрим главные отличия от конкурентов на момент выхода на рынок:
1. Нет жестких требований к протоколу клиент-сервер (для передачи контрольных сообщение можно использовать даже чат)
2. Бесплатные кодеки для видео (VP8) и аудио (G.711, iSAC)
3. Простой API и поддержка в набиравшем популярность Chrome. 

Все это было нацелено на аудиторию web-разработчиков. Они могли с легкостью использовать WebRTC не вникая в подробности реализации самой технологии. 
Но WebRC - это не только браузер. На сегодняшний день мы можем использовать эту технологию на любой платформе где можно скомпилировать С++ код. Ведь в основе лежат всё те же RTP для медиа данных и WebSocket (в большинстве случаев) для сигналинга. 

#### Основные компоненты WebRTC

На поверхности лежит JavaScript API. Она состоит оз 4 основных модулей:
1.  **getUserMedia** - позволяет работать с устройствами захвата видео/аудио. Дает возможность их настраивать и переключатся между ними. 
2. **RTCPeerConnection** - самый основной компонент. Включает в себя логику по сигналингу и передаче медиа данных. Сюда входит: кодирование, энкриптирование, контроль пропускной способности и много другое.
3. **RTCDataChannel** - Вспомогательный компонент для передачи данных отличных от видео/аудио потоков. Это могут быть файлы или чтото вроде чата.
4. **getStats** - Очень мощный инструмент для получения информации о текущих стримах. Часто используется для отладки приложений или чтобы собирать статистику для аналитики.

Все выгладит довольно просто снаружи, давайте теперь заглянем внутрь API. Внутри у нас гигабайты С++ кода, разбитого на модули. Расмотрим основные из них:

![Architecture](pictures/webrtc-public-diagram-for-website.png)

##### Your Web App
Так как изначально WebRTC задумывался как удобный инструмент разработки видео-звонков внутри браузера, то естественно оргомное внимание уделено WebAPI. Оно используется Web-приложениями. Они на вершине данной схемы.

##### Web API
Включает в себя все модули WebRTC и скрывает довольно сложную архитекруту, чтобы разработчики сконцентрировались исключительно на бизнес логике своих приложений и делали этот Мир лучше. ;)

##### WebRTC Native C++ API**
Дальше идет уровень API которым пользуються разработчики браузеров для реализации собственных WebAPI. Также этот уровень API используется программистами для создания WebRTC медиа серверов. Или например WebRTC клиентов для нативных мобильных приложений, или десткоп-приложений на разных платформах. Иными словами, это точнка входа для не web-программистов. ;)

Рассмотрим основные компоненты WebRTC. Все они open-source и все уже прошли проверку временем еще до включения их в состав WebRTC:

##### Session Management
Абстрактный уровень, который отвечает за установку соединения (сигналинг). Протокол может быть разный, способ доставки служебных сообщений внутри этого протокола тоже может быть какой угодно. Обычно используют WebSocket.

##### Transport / Session
Траспортный модуль для осуществления передачи медиа данных заимствовани у библиотеки *libjingle*. Это аналог xmpp/jingle протокола который используется в приложениях для обмена сообщениями с 1999 года. Его можно разбить н а3 основных компонента:

1. **SRTP Stack** - Используется для передачи медиа данных. Транспортный уровень при этом - *UDP*. Одна из главных преимуществ WebRTC - это секюрность. И она уже включена в протоколы передачи данных. Также используется протокол *RTCP* для передачи контрольных пакетов.

2. **Multiplexing** - модуль который объеденяет аудио и видео потоки (Bundle) и/или RTP пакеты с RTCP пакетами (rtcp-mux). Это позволяет сэкономить ресурсы на открытие UDP портов. А в случае с серверами - позволит обслуживать больше клиентов одновременно.

3. **STUN/TURN/ICE** - Модуль который позволяет использовать STUN и ICE механизмы для установления соединения сквозь разные типы фаерволлов.

##### Voice Engine

Набор модулей которые отвечают за доставку аудио данных от источников звука до сети. Основными из них являются:

1. **iSAC / iLBC / Opus** - Как мы уже рассматривали, WebRTC включает в себя набор аудио-кодеков. Часть из них пришла с поглощение мкомпании On2. К ним добавился популярный на сегодняшний день *opus*. Opus является open-source продуктом в реультате совместной работы инженеров из разных компаний. Активное участие в разработке принимали нженеры Skype.

2. **NetQE for voice** - модуль для поддержания максимально низкой буферизации аудио-данных при плохих условиях соединений. Также здесь происходит устранение неприятных аудио-эффектов при потере пакетов.

3. **Acoustic Echo Canceler (AEC)** - программные алгоритмы для устранения эффекта эхо, когда в микрофон попадают сказанные слова вернувшиеся от собеседника. Например когда вы общаетесь без наушников с помощью ноутбука.

4. **Noise Reduction (NR)** - модуль который определяет посторонние шумы и удаляет их их адуио сигнала. В результате собеседник слышит более чистый звук.

##### Voice Engine

Набор модулей ля доставки видео сигнала из источников видео (камера, экран) до сети.

1. **VP8/VP9/h.264** - На сегодняшний день широко используются эти кодеки. VP9 только выходит на арену, и еще не все устройства его поддерживают. WebRTC позволяет выбрать любой из них, но тут нужно учитывать конкретные задачи и целевую аудиторию. Некоторые устройства имеют аппаратную поддержку h.264, некоторые - VP8. WebRTC дает возможность разработчикам самим выбирать приоритные кодеки. А конкретный кодек для сессии выбирается на этапе сигналинга, но об этом чуть позже.

2. **Video Jitter Buffer** - буфер видео-данных для сглаживания потерь при передече данных. В результате пользователь получает более приятную картинку с минимальной задержкой относительно источника.

3. **Image enhancements** - сюда можно отнести полезные фишки обработки видео, например очистка от шумовб и т.д.

#### Как это работает

#### Защищенность

#### Статистика


### Источники
[1] https://bloggeek.me/webrtc/
[2] https://webrtc.org/architecture/
